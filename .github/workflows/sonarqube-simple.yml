name: SonarQube PR Check (Simple)

on:
  pull_request:
    branches:
      - main
      - master
      - develop

jobs:
  sonarqube-scan:
    name: SonarQube Scan & Quality Gate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Run SonarQube Scanner
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        continue-on-error: true
        id: sonar_scan
      
      - name: Wait for Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        continue-on-error: true
        id: quality_gate
      
      - name: Send Slack Notification on Failure
        if: failure() || steps.quality_gate.outcome == 'failure'
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "channel": "#testing-sonarqube",
              "username": "SonarQube Bot",
              "icon_emoji": ":warning:",
              "attachments": [{
                "color": "danger",
                "title": "❌ SonarQube Quality Gate Failed",
                "text": "The SonarQube quality gate check failed for this pull request.",
                "fields": [
                  {
                    "title": "Repository",
                    "value": "${{ github.repository }}",
                    "short": true
                  },
                  {
                    "title": "Pull Request",
                    "value": "<${{ github.event.pull_request.html_url }}|PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}>",
                    "short": false
                  },
                  {
                    "title": "Branch",
                    "value": "${{ github.head_ref }}",
                    "short": true
                  },
                  {
                    "title": "Author",
                    "value": "${{ github.event.pull_request.user.login }}",
                    "short": true
                  },
                  {
                    "title": "View Details",
                    "value": "<${{ github.event.pull_request.html_url }}|View Pull Request>",
                    "short": false
                  }
                ],
                "footer": "GitHub Actions",
                "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
              }]
            }' \
            ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: Fail if Quality Gate Failed
        if: steps.quality_gate.outcome == 'failure'
        run: |
          echo "❌ SonarQube Quality Gate failed!"
          echo "Please fix the issues and try again."
          exit 1

